<script type="text/x-red" data-template-name="wws-credentials">
    <div class="form-row">
        <label for="node-config-input-accountName" title="The name of the Watson Workspace App used to create the App."><i class="fa fa-tag"></i> App Name</label>
        <input type="text" id="node-config-input-accountName" readonly placeholder="Will be filled from Watson Work Service...">
    </div>
    <div class="form-row">
        <label for="node-config-input-clientId" title="The application identifier issued to the client during the Application registration process."><i class="fa fa-user-circle"></i> App ID</label>
        <input type="text" id="node-config-input-clientId">
    </div>
    <div class="form-row" id="node-config-input-clientId-status" style="color:red; display:none;">
        <small class="form-text text-muted"><span>Please enter a valid app ID</span></small>
    </div>
    <div class="form-row">
        <label for="node-config-input-clientSecret" title="The application secret issued to the client during the Application registration process."><i class="fa fa-user-secret"></i> App Secret</label>
        <input type="password" id="node-config-input-clientSecret" autocomplete="off">
    </div>
    <div class="form-row" id="node-config-input-clientSecret-status" style="color:red; display:none;">
        <small class="form-text text-muted"><span>Please enter a valid app secret</span></small>
    </div>
    <style>
        .radioGroup input[type="radio"] {
            margin-top: 0px;
            margin-bottom: 4px;
            width: 10%;
        }
        .radioGroup span {
            width: 60%;
        }
    </style>
    <div class="form-row radioGroup" id="radio-group-user">
        <label title="The type of token to be used. Either Bot or User. If user is selected, the app will gain the same rights as the user configuring this node."><i class="fa fa-credit-card"></i> Token Type</label>
        <input type="radio" name="tokenType" value="bot" checked="checked"><span><li class="fa fa-comment"></i>  Bot</span>
    </div>
    <div class="form-row radioGroup" id="radio-group-bot">
        <label>&nbsp;</label>
        <input type="radio" name="tokenType" value="user"><span><li class="fa fa-user"></i> User</span>
    </div>
    <div class="form-row" id="authenticate-user" style="display:none;">
        <label>&nbsp;</label>
        <a class="btn disabled" id="btn-user-authenticate" href="#" target="_blank">Authenticate to retrieve token</a>
    </div>
    <div class="form-row" id="authenticate-bot" style="display:none;">
        <label>&nbsp;</label>
        <a class="btn disabled" id="btn-bot-authenticate" href="#">Retrieve token</a>
    </div>
<!-- Commented OAuth out
    <div class="form-row">
        <label for="node-config-input-api" title="The base URL for the Watson Workspace API"><i class="fa fa-external-link"></i> API URL</label>
        <input type="text" id="node-config-input-api" placeholder="https://api.watsonwork.ibm.com" >
    </div>
    <div class="form-row">
        <label for="node-config-input-accessTokenPath" title="The endpoint for authentication server. This is used to exchange the authorization code for an access token."><i class="fa fa-cog"></i> Token Path</label>
        <input type="text" id="node-config-input-accessTokenPath" placeholder="/oauth/token" >
    </div>
    <div class="form-row">
        <label for="node-config-input-revokeTokenPath" title="The endpoint for authentication server. This is used to revoke an existing access token in case of a User or App logout."><i class="fa fa-cog"></i> Revoke Path</label>
        <input type="text" id="node-config-input-revokeTokenPath" placeholder="/oauth/revoke" >
    </div>
    <div class="form-row">
        <label for="node-config-input-authorizePath" title="The endpoint for authorization server. This is used to get the authorization code."><i class="fa fa-cog"></i> Auth Path</label>
        <input type="text" id="node-config-input-authorizePath" placeholder="/oauth/authorize" >
    </div>
-->
    <!-- Fields required for setting up the authentication method -->
    <input id="node-config-input-tokenType" type="hidden">
    <input id="tokenType-user-userName" type="hidden">
    <input id="tokenType-user-userID" type="hidden">
<!-- Hover Information does not need to be displayed here
    <div class="form-tips">
		<h4>Tip</h4>
		<p>Hover over each label to receive additional hints for each field.</p>
    </div>
-->
    <div class="form-tips" id="userInformation" style="display:none;">

    </div>
</script>

<script type="text/x-red" data-help-name="wws-credentials">
    <p>Stores the app specific account information provided by Watson Work.</p>
    <h3>Details</h3>
    <p>For each <a href=\"https://developer.watsonwork.ibm.com/apps\" target=\"_blank\">Watson Work App</a> which should be supported an own account has to be created.<br/>
        Provide the following information:
    </p>
    <dl class="message-properties">
        <dt>Account Name</dt>
            <dd>This should match with the name you provided for your Watson Work App.</dd>
        <dt>App ID</dt>
            <dd>The application ID provided during the App Registration Process.</dd>
        <dt>App Secret</dt>
            <dd>The application secret provided during the App Registration Process.</dd>
        <!--
        <dt class="optional">API URL</dt>
            <dd>Default value <code>https://api.watsonwork.ibm.com</code>, override it if required.</dd>
        <dt class="optional">Token Path</dt>
            <dd>Default value <code>/outh/token</code>, override it if required. Check reference section for details.</dd>
        <dt class="optional">Revoke Path</dt>
            <dd>Default value <code>/outh/revoke</code>, override it if required. Check reference section for details.</dd>
        <dt class="optional">Auth Path</dt>
            <dd>Default value <code>/outh/authorize</code>, override it if required. Check reference section for details.</dd>
        -->
    </dl>
    <h3>References</h3>
    <ul>
        <li><a href="https://developer.watsonwork.ibm.com/docs/api-reference/authenticate-as-an-app" target="_blank">Authenticate as App</a> - Reference Documentation for the <code>Authentication as App</code> process flow</li>
        <li><a href="https://developer.watsonwork.ibm.com/docs/api-reference/authorize-on-behalf-of-a-user" target="_blank">Authorize on behalf of an user</a> - Reference Documentation for the <code>Authorize on behalf of an user</code> process flow</li>
        <li><a href="https://developer.watsonwork.ibm.com/docs/api-reference/get-user-access-token" target="_blank">Get User Access Token</a> - Reference Documentation for the <code>Get User Access Token</code> process flow</li>
        <li><a href="https://developer.watsonwork.ibm.com/docs/api-reference/refresh-user-access-token" target="_blank">Refresh User Access Token</a> - Reference Documentation for the <code>Refresh User Access Token</code> process flow</li>

    </ul>
</script>

<script type="text/javascript">
(function() {
    var poller;

    /* Default Values*/
    var api = "https://api.watsonwork.ibm.com";
    var tokenPath = "/oauth/token";
    var authorizePath = "/oauth/authorize";

    /* Helper Functions */
    function removeToken(id) {
        return $.getJSON("wws/app/"+ id +"/remove")
        .done((data, textStatus, xhr) => {
            console.log("data: " + JSON.stringify(data));
            console.log("textStatus: " + JSON.stringify(textStatus));
            console.log("status: " + JSON.stringify(xhr));
        }).fail(( xhr, textStatus, error ) => {
            console.log("xhr: " + JSON.stringify(xhr));
            console.log("textStatus: " + JSON.stringify(textStatus));
            console.log("error: " + JSON.stringify(error));
            var err = textStatus + ", " + JSON.stringify(error);
            console.log( "Request Failed: " + err );
        }).always((data, textStatus, xhr) => {
            console.log("data: " + JSON.stringify(data));
            console.log("textStatus: " + JSON.stringify(textStatus));
            console.log("status: " + JSON.stringify(xhr));
        });
    };
    function getToken(id) {
        return $.getJSON("wws/app/"+ id +"/token")
        .done((data, textStatus, xhr) => {
            console.log("data: " + JSON.stringify(data));
            console.log("textStatus: " + JSON.stringify(textStatus));
            console.log("status: " + JSON.stringify(xhr));
        }).fail(( xhr, textStatus, error ) => {
            console.log("xhr: " + JSON.stringify(xhr));
            console.log("textStatus: " + JSON.stringify(textStatus));
            console.log("error: " + JSON.stringify(error));
            var err = textStatus + ", " + JSON.stringify(error);
            console.log( "Request Failed: " + err );
        }).always((data, textStatus, xhr) => {
            console.log("data: " + JSON.stringify(data));
            console.log("textStatus: " + JSON.stringify(textStatus));
            console.log("status: " + JSON.stringify(xhr));
        }); 
    };

    function getAppName(id, appId) {
        return $.getJSON("wws/app/"+ id +"/name/"+appId)
        .done((data, textStatus, xhr) => {
            console.log("data: " + JSON.stringify(data));
            console.log("textStatus: " + JSON.stringify(textStatus));
            console.log("status: " + JSON.stringify(xhr));
        }).fail(( xhr, textStatus, error ) => {
            console.log("xhr: " + JSON.stringify(xhr));
            console.log("textStatus: " + JSON.stringify(textStatus));
            console.log("error: " + JSON.stringify(error));
            var err = textStatus + ", " + JSON.stringify(error);
            console.log( "Request Failed: " + err );
        }).always((data, textStatus, xhr) => {
            console.log("data: " + JSON.stringify(data));
            console.log("textStatus: " + JSON.stringify(textStatus));
            console.log("status: " + JSON.stringify(xhr));
        }); 
    };

    RED.nodes.registerType('wws-credentials',{
        category: 'config',
        defaults: {
            accountName: {value:""},
            clientId: {value:"", required:true},
            clientSecret: {value:"", required:true},
            tokenType:{value:"bot", required:true}
        },
        label: function() {
            return this.accountName;
        },
        exportable: false,
        oneditprepare: function() {
            var wwsConfigNodeId = this.id;
            
            //TokenType Handling
            var inputRadioUser = $("input[name=tokenType][value='user']");
            var inputRadioBot = $("input[name=tokenType][value='bot']");
            var radioGroupUser = $("#radio-group-user");
            var radioGroupBot = $("#radio-group-bot");
            
            var inputTokenType = $('#node-config-input-tokenType');
            var btnBotAuthenticate = $('#btn-bot-authenticate');
            btnBotAuthenticate.click(function(event) {
                if (checkInputFields() && !btnBotAuthenticate.hasClass("disabled")) {
                    btnBotAuthenticate.addClass("disabled");
                    getCallbackUrl(wwsConfigNodeId);
                }
                event.preventDefault();
            });

            var btnUserAuthenticate = $('#btn-user-authenticate');
            btnUserAuthenticate.click(function(event) {
                if (checkInputFields() && !btnUserAuthenticate.hasClass("disabled")) {
                    btnUserAuthenticate.addClass("disabled");
                    searchForUserInformation();
                } else {
                    event.preventDefault();
                }
            });
            
            let disableStartAuthenticationButtons = () => {
                switch (inputTokenType.val()) {
                    case "user":
                        btnUserAuthenticate.addClass("disabled");
                        //TODO: Create poller;
                        break;
                    default:
                    case "bot":
                        btnBotAuthenticate.addClass("disabled");
                        //TODO: Remove poller;
                        break;
                };
            };
            let enableStartAuthenticationButtons = () => {
                switch (inputTokenType.val()) {
                    case "user":

                        break;
                    default:
                    case "bot":

                        break;
                };
            };
            let getCredentials = () => {
                return {
                    client: {
                        id: $('#node-config-input-clientId').val(),
                        secret: $('#node-config-input-clientSecret').val()
                    },
                    auth: {
                        tokenHost: api,
                        tokenPath: tokenPath,
                        authorizeHost: api,
                        authorizePath: authorizePath
                    }
                };
            }

            let checkInputFields = () => {
                var success = false;
                if (!$('#node-config-input-clientId').val()) {
                    success = false;
                    $('#node-config-input-clientId-status').show();
                } else {
                    success = true;
                    $('#node-config-input-clientId-status').hide();
                }
                if (success && !$('#node-config-input-clientSecret').val()) {
                    success = false;
                    $('#node-config-input-clientSecret-status').show();
                } else if (success) {
                    success = true;
                    $('#node-config-input-clientSecret-status').hide();
                }
                if (success) {
                    radioGroupUser.show();
                    radioGroupBot.show();
                    if (inputTokenType.val() === "user") {
                        $('#authenticate-user').show();
                    } else {
                        btnBotAuthenticate.removeClass("disabled");
                        $('#authenticate-bot').show();
                    }
                } else {
                    if (inputTokenType.val() === "user") {
                        $('#authenticate-user').hide();
                    } else {
                        $('#authenticate-bot').hide();
                        btnBotAuthenticate.addClass("disabled");
                    }
                    radioGroupUser.hide();
                    radioGroupBot.hide();
                }
                console.log("CheckInputFields: "+success);
                return success;
            };
            let switchTokenType = (inputTokenType, init) => {
                btnUserAuthenticate.addClass("disabled");
                if (!init) {
                    clearCurrentToken();
                }
                switch (inputTokenType.val()) {
                    case "user":
                        inputRadioUser.prop("checked",true);
                        inputRadioBot.prop("checked",false);
                        if (!init) {
                            $('#authenticate-bot').hide();
                            $('#authenticate-user').show();
                            getCallbackUrl(wwsConfigNodeId);
                        }
                        break;
                    default:
                    case "bot":
                        inputRadioBot.prop("checked",true);
                        inputRadioUser.prop("checked",false);
                        if (!init) {
                            $('#authenticate-user').hide();
                            $('#authenticate-bot').show();
                        }
                        break;
                };
                if (checkInputFields()) {
                    enableStartAuthenticationButtons();
                } else {
                    disableStartAuthenticationButtons();
                }
            };

            let getCallbackUrl = function(id) {

                let currentUri = window.location;
               
                var data = {
                    "credentials": getCredentials(),
                    "protocol": currentUri.protocol,
                    "hostname": currentUri.hostname,
                    "port":currentUri.port,
                    "tokenType": inputTokenType.val()
                }

                $.post("/wws/app/" + id + "/auth/url", data, function(response, textStatus, xhr) {
                    if (response.url) {
                        btnUserAuthenticate.attr('href', response.url);
                        btnUserAuthenticate.removeClass("disabled");
                    } else if (response.access_token) {
                        displayTokenInformation(response);
                        getAppName(id, $('#node-config-input-clientId').val())
                        .then((result) => {
                            if (result.error) {
                                console.error("Could not receive AppName! " + JSON.stringify(result.error));
                            } else if (result.appName) {
                                $("#node-config-input-accountName").val(result.appName);
                            } else {
                                console.error("Check Output!");
                            }
                        });
                    }
                }, "json")
                .fail((xhr) => {
                    console.log("XHR: " + JSON.stringify(xhr));
                    //TODO: Display error msg...
                    btnBotAuthenticate.removeClass("disabled");
                });
            };

            let clearCurrentToken = () => {
                $('#userInformation').html("<p>No token information has been provided yet!</p>");
                $('#userInformation').hide();
                
                removeToken(wwsConfigNodeId)
                .then(() => {
                    console.log("Token " + wwsConfigNodeId + " has been removed");
                    $("#node-config-dialog-ok").button("disable");
                    $("#node-config-dialog-cancel").button("disable");
                });
            };

            let getCurrentToken = () => {
                getToken(wwsConfigNodeId)
                .then((token) => {
                    console.log("Token: " + JSON.stringify(token));
                    displayTokenInformation(token);
                    getAppName(wwsConfigNodeId, $('#node-config-input-clientId').val())
                    .then((result) => {
                        if (result.error) {
                            console.error("Could not receive AppName! " + JSON.stringify(result.error));
                        } else if (result.appName) {
                            $("#node-config-input-accountName").val(result.appName);
                        } else {
                            console.error("Check Output!");
                        }
                    });
                });
            }

            let hasUserToken = () => {
                var userInformation = $('#userInformation > h4');
                console.log("userInformation: " + JSON.stringify(userInformation.html()));
                if (userInformation && userInformation.length>0) {
                    return true;
                } else {
                    return false;
                }
            };

            let searchForUserInformation = function() {
                let releaseInterval = (intervalObj) => {
                    poller = undefined;
                    clearInterval(intervalObj);
                };
                if (!poller && !hasUserToken()) {
                    const intervalObj = setInterval(() => {
                        getCurrentToken();
                        if (hasUserToken()) {
                            releaseInterval(intervalObj);
                        };
                    }, 1000);
                    poller = intervalObj;
                };
            }
            let displayTokenInformation = (token) => {
                var scopes;
                var html = "<h4>Token Information</h4>";
                    if (token.displayName) {
                        scopes = token.scope;
                        html+="<p>"+token.displayName+" ("+token.id+")</p>";
                    } else {
                        //In case of tokenType==='bot'
                        scopes = token.scope
                        html+="<p>"+$('#node-config-input-accountName').val()+" ("+token.id+")</p>";
                    }
                    html+="<p><b>Access Rights</b></p>";
                    html+="<ul>";
                    $.each(scopes, function(index, value) {
                        html+="<li>"+value+"</li>";
                    });
                    html+="</ul>";
                    console.log(html);
                    $('#authenticate-bot').hide();
                    $('#authenticate-user').hide();
                    $('#userInformation').html(html);
                    $('#userInformation').show();
                    $("#node-config-dialog-ok").button("enable");
                    $("#node-config-dialog-cancel").button("enable");
            };
            
            //Initial Settings
            $("#node-config-dialog-ok").button("disable");
            $("#node-config-dialog-cancel").button("disable");

            if (!inputTokenType.val()) {
                inputTokenType.val("bot");
            }
            switchTokenType(inputTokenType, true);

            if (checkInputFields()) {
                searchForUserInformation();
            }

            inputRadioUser.click(function(event) {
                inputTokenType.val(inputRadioUser.val());
                switchTokenType(inputTokenType);
            });
            inputRadioBot.click(function(event) {
                inputTokenType.val(inputRadioBot.val());
                switchTokenType(inputTokenType);
            });

            var inputAppId = $('#node-config-input-clientId');
            inputAppId.focusout(function(event) {
                if (checkInputFields()) {
                    enableStartAuthenticationButtons();
                } else {
                    disableStartAuthenticationButtons();
                }
            });
            inputAppId.keydown(function(event) {
                if (event.keyCode == 9/*Tab Key*/) {
                    console.log(event);
                    if (checkInputFields()) {
                        enableStartAuthenticationButtons();
                    } else {
                        disableStartAuthenticationButtons();
                    }
                }
            });
            var inputAppSecret = $('#node-config-input-clientSecret');
            inputAppSecret.focusout(function(event) {
                if (checkInputFields()) {
                    enableStartAuthenticationButtons();
                } else {
                    disableStartAuthenticationButtons();
                }
            });
            inputAppSecret.keydown(function(event) {
                if (event.keyCode == 9/*Tab Key*/) {
                    console.log(event);
                    if (checkInputFields()) {
                        enableStartAuthenticationButtons();
                    } else {
                        disableStartAuthenticationButtons();
                    }
                }
            });
        },
        oneditsave: function() {
            clearInterval(poller);
        },
        oneditcancel: function() {
            console.log("Clearing interval with ID " + poller);
            clearInterval(poller);
        },
        oneditdelete: function() {
            clearInterval(poller);
            removeToken(wwsConfigNodeId)
            .then(() => {
                console.log("Token " + wwsConfigNodeId + " has been removed");
            });
        }
    });
})();
</script>
